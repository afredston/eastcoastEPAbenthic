---
title: "Data Prep"
output: html_notebook
---

Starting with a clean environment:
```{r}
rm(list=ls())
```


```{r}
library("tidyverse")
library("here")
library("taxize") #for standardizing taxonomy - but so far I haven't needed this since all old taxons matched with corrections provided in the 2010 dataset
#remotes::install_github("ropensci/rfishbase")
library("rfishbase")
library("dplyr")
library("stringi")
```

Downloaded all benthic macroinvertebrate files from EPA. Had to also download site info files for some.
```{r}
BC2000<-read_csv(here("current work", "raw data", "nca_benthicdata.csv")) #data w species counts early 2000's
BC2010a<-read_csv(here("current work", "raw data", "assessed_ncca2010_benthic_data.csv")) #data w species counts 2010 (used in water quality assessments)
BC2010b<-read_csv(here("current work", "raw data", "not_assessed_ncca2010_benthic_data.csv")) #data w species counts 2010 (not used in water quality assessments) NOTE: we don't have the necessary info (such as LAT and LON) on the grabs for this data in the following file *maybe can find this in a water chemistry file -got it!
BG2010<-read_csv(here("current work", "raw data", "ncca2010_benthic_indicator_status.csv")) #data w necessary info on grabs
BG2015<-read_csv(here("current work", "raw data", "ncca_2015_benthic_grab_estuarine-data.csv")) #data on the just the grabs 2015
BC2015<-read_csv(here("current work", "raw data", "ncca_2015_benthic_count_estuarine-data.csv")) #data w species counts 2015
BC2015sites<-read_csv(here("current work", "raw data", "ncca_2015_site_information_estuarine-data.csv")) #data w site info 2015
BG2020<-read_csv(here("current work", "raw data", "ncca20_bentgrab_data.csv")) #data on just the grabs 2020
BC2020<-read_csv(here("current work", "raw data", "ncca20_bentcount_data.csv")) #data w species counts 2020
BC2020Esites<-read_csv(here("current work", "raw data", "ncca20_siteinfo_estuaries_data_2.csv")) # estuary site info 2020
BC2020Rsites<-read_csv(here("current work", "raw data", "ncca20_siteinfo_reef_flats_data.csv")) #reef flat site info 2020

#missing coordinates data for 2015
#BG2015
#BC2015
```

# Step 1: Cut data so only considering east coast marine estuaries 
Using the buoy marking the southern most extent of Florida located at 24.469833 N, -80.20817 E and selecting only observations made NE of it to get only east coast observations.
```{r}
BC2000<-BC2000 %>%
  filter(LON_DD > -80.20817 & LAT_DD > 24.469833) %>% #note: this filter alone will give all of the east coast observations since there are no other observations NE of this point
  filter(NCA_REGION == "East_Coast") # but can ensure by adding this

BC2010a<-merge(BC2010a, BG2010, by = "UID") #merging these two data frames so can get the coordinates of each grab sample since these aren't in the count data
BC2010a<-BC2010a %>%
  filter(LON_DD > -80.20817 & LAT_DD > 24.469833) %>%
  filter(RSRC_CLASS == "NCA_Estuarine_Coastal") #to remove Great Lakes samples located NE of this point
BC2010b

BC2015sites
coords<-BC2015sites %>% select(UID, LON_DD, LAT_DD, NCA_REG) # get coordinates for each site and region info from the 2010 data
BC2015<-merge(BC2015, coords, by="UID")
BC2015 %>%
  filter(LON_DD > -80.20817 & LAT_DD > 24.469833) %>% #note: this filter alone will give all of the east coast observations since there are no other observations NE of this point
  filter(NCA_REG == "East_Coast") # but can ensure by adding this

BC2020 %>% filter(HABITAT == "EST")
coords<-BC2020Esites %>% select(UID, LON_DD, LAT_DD, NCA_REG) # get coordinates for each site and region info from the 2020 estaury data
BC2020<-merge(BC2020, coords, by = "UID")
BC2020 %>%
  filter(LON_DD > -80.20817 & LAT_DD > 24.469833) %>% #note: this filter alone will give all of the east coast observations since there are no other observations NE of this point
  filter(NCA_REG == "East_Coast") # but can ensure by adding this

#DATA we care about:
BC2000
BC2010a
BC2010b
BC2015
BC2020
```

# Step 2: Match up taxonomy of early 2000's with 2010 data. Then match up taxonomy to data in sealifbase.
```{r}
BC2000x<-BC2000 %>% mutate(TAXON_ORIGINAL = taxon) #create column to match up the original taxon names in the 2000s data to the original taxon names in the 2010 data
txn_cors<-BC2010a %>%
  select("TAXON_ORIGINAL", "TAXON_CORRECTED", "WORMS_APHIAID") #taxonomic corrections applied to 2010 data
BC2000cor<-merge(BC2000x, txn_cors, by="TAXON_ORIGINAL") #matching up the corrections applied to the 2010 data to the 2000s data

#CHECK out the corrections that were applied:
#BC2000cor %>% select("TAXON_ORIGINAL", "taxon", "TAXON_CORRECTED", "WORMS_APHIAID") %>%
#  filter(taxon != TAXON_CORRECTED)

# ********TRYING TO MATCH UP SPECIES IN THE EARLY 2000s DATA WITH EITHER WORMS OR SEALIFEBASE!!! NOT WORKING!!!************
BC2000cor %>% select(TAXON_CORRECTED, WORMS_APHIAID) %>% unique() #to look at corrected names and their supposed AphiaIDs in WoRMS
BC2000cor %>% select(TAXON_CORRECTED) %>% unique() %>% validate_names() #trying to match sealifebase gives us nothing!!!
validate_names("Acanthohaustorius intermedius") #trying name by name I'm getting nothing either....
# searching this species name directly in sealifebase.org's online portal I get a result though...
wormsIDs2000<-BC2000cor %>% select(WORMS_APHIAID) %>% unique() #extracting the IDs...
wormsIDs2000
worms_downstream(id=wormsIDs2000[,1], downto="species") #...and searching for them in WoRMS also is giving me nothing
```

































```{r}
fb_tbl("species", "sealifebase")
```




